<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Product Management | Admin
  </title>
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- Font Awesome 6 -->
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
   <!-- SweetAlert2 -->
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.min.css" rel="stylesheet"/>
   <!-- Global Theme CSS -->
   <link href="style.css" rel="stylesheet"/>
   <!-- Page-specific CSS -->
   <link href="product_management_page.css" rel="stylesheet"/>
  </link>
 </head>
 <body class="view-table">
  <!-- ADMIN COMPONENT: Header (Role: Admin) -->
  <style>
   .admin-navbar { background-color: var(--primary); }
    .admin-navbar .nav-link, .admin-navbar .navbar-brand, .admin-navbar .navbar-text { color:#fff; }
    .admin-navbar .nav-link:hover { color:#212529; background: rgba(255,255,255,.2); border-radius:.375rem; }
    .badge-dot { width:8px; height:8px; background:#dc3545; border-radius:50%; display:inline-block; margin-left:-6px; margin-top:-6px; position:absolute; }
  </style>
  <nav class="navbar navbar-expand-lg admin-navbar py-2">
   <div class="container-fluid">
    <button aria-controls="appSidebar" aria-label="Toggle sidebar" class="btn btn-light d-lg-none me-2" data-bs-target="#appSidebar" data-bs-toggle="offcanvas" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./admin_dashboard.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/acme/28/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68a81bcf3010074de4818175/logos/logo_32990785-4b39-4b20-94b8-b390fa991550.jpg" style="height:28px;width:28px;border-radius:.25rem;"/>
     Admin
    </a>
    <div class="d-none d-lg-flex flex-grow-1 mx-3">
     <form action="./product_management_page.html" class="w-50" method="GET" role="search">
      <div class="input-group">
       <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass">
        </i>
       </span>
       <input aria-label="Search" class="form-control" id="globalSearch" placeholder="Search products, users, models…" type="search"/>
      </div>
     </form>
    </div>
    <ul class="navbar-nav ms-auto align-items-center gap-2">
     <li class="nav-item d-none d-lg-block">
      <a class="btn btn-light btn-sm" href="./upload_page.html">
       <i class="fa-solid fa-file-arrow-up me-1">
       </i>
       Upload Data
      </a>
     </li>
     <li class="nav-item d-none d-lg-block">
      <a class="btn btn-dark btn-sm" href="./model_management_page.html#train" style="background-color: var(--secondary); border-color: var(--secondary);">
       <i class="fa-solid fa-rocket me-1">
       </i>
       Train Model
      </a>
     </li>
     <li class="nav-item dropdown">
      <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" role="button">
       <span class="avatar rounded-circle bg-dark d-inline-flex justify-content-center align-items-center me-2" style="width:28px;height:28px;">
        <i class="fa-solid fa-user-gear text-white small">
        </i>
       </span>
       <span class="d-none d-sm-inline" id="currentUserName">
        Admin User
       </span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
       <li>
        <h6 class="dropdown-header">
         Admin
        </h6>
       </li>
       <li>
        <a class="dropdown-item" href="./admin_dashboard.html#settings">
         <i class="fa-solid fa-gear me-2">
         </i>
         Settings
        </a>
       </li>
       <li>
        <hr class="dropdown-divider"/>
       </li>
       <li>
        <a class="dropdown-item" href="./login_page.html">
         <i class="fa-solid fa-right-from-bracket me-2">
         </i>
         Logout
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </div>
  </nav>
  <!-- ADMIN COMPONENT: Sidebar (Role: Admin) -->
  <style>
   :root { --primary:#f08e1b; --secondary:#9a296a; }
    .admin-sidebar .nav-link { color:#333; border-radius:.375rem; }
    .admin-sidebar .nav-link:hover { background:rgba(240,142,27,.12); color:var(--secondary); }
    .admin-sidebar .nav-link.active { background:rgba(240,142,27,.18); color:#000; border-left:4px solid var(--primary); }
    .admin-sidebar .section-title { font-size:.75rem; color:#6c757d; text-transform:uppercase; letter-spacing:.08em; margin:1rem 0 .25rem; }
    .admin-sidebar .profile { background:linear-gradient(90deg, rgba(240,142,27,.08), rgba(154,41,106,.08)); border-radius:.5rem; }
  </style>
  <div aria-labelledby="appSidebarLabel" class="offcanvas offcanvas-start offcanvas-lg admin-sidebar" id="appSidebar" tabindex="-1">
   <div class="offcanvas-header d-lg-none">
    <h5 class="offcanvas-title" id="appSidebarLabel">
     Admin Navigation
    </h5>
    <button aria-label="Close" class="btn-close text-reset" data-bs-dismiss="offcanvas" type="button">
    </button>
   </div>
   <div class="offcanvas-body p-0 d-flex flex-column">
    <div class="p-3 border-bottom">
     <a class="d-flex align-items-center text-decoration-none" href="./admin_dashboard.html">
      <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/acme/32/32';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68a81bcf3010074de4818175/logos/logo_32990785-4b39-4b20-94b8-b390fa991550.jpg" style="height:32px;width:32px;object-fit:cover;border-radius:.25rem;"/>
      <span class="fw-semibold" style="color:var(--secondary)">
       Sales Forecasting Admin
      </span>
     </a>
    </div>
    <div class="p-3 profile d-flex align-items-center gap-2">
     <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width:40px;height:40px;background-color: var(--secondary) !important; color:#fff;">
      <i class="fa-solid fa-user">
      </i>
     </div>
     <div>
      <div class="fw-semibold" id="sidebarUser">
       Admin User
      </div>
      <div class="text-muted small">
       Admin
      </div>
     </div>
    </div>
    <nav class="px-2 py-2 sidebar-nav">
     <div class="section-title px-2">
      Overview
     </div>
     <ul class="nav nav-pills flex-column mb-2">
      <li class="nav-item">
       <a class="nav-link d-flex align-items-center" href="./admin_dashboard.html">
        <i class="fa-solid fa-gauge me-2">
        </i>
        Dashboard
       </a>
      </li>
     </ul>
     <div class="section-title px-2">
      Data
     </div>
     <div class="accordion accordion-flush" id="dataAccordion">
      <div class="accordion-item border-0">
       <h2 class="accordion-header" id="headingData">
        <button aria-controls="collapseData" aria-expanded="false" class="accordion-button collapsed py-2" data-bs-target="#collapseData" data-bs-toggle="collapse" type="button">
         <i class="fa-solid fa-database me-2">
         </i>
         Data Management
        </button>
       </h2>
       <div aria-labelledby="headingData" class="accordion-collapse collapse show" data-bs-parent="#dataAccordion" id="collapseData">
        <div class="accordion-body py-2">
         <ul class="nav nav-pills flex-column gap-1">
          <li>
           <a class="nav-link ps-4" href="./upload_page.html">
            <i class="fa-solid fa-file-arrow-up me-2">
            </i>
            Upload Data
           </a>
          </li>
          <li>
           <a class="nav-link ps-4 active" href="./product_management_page.html">
            <i class="fa-solid fa-boxes-stacked me-2">
            </i>
            Product Management
           </a>
          </li>
         </ul>
        </div>
       </div>
      </div>
     </div>
     <div class="section-title px-2">
      Users
     </div>
     <ul class="nav nav-pills flex-column mb-2">
      <li class="nav-item">
       <a class="nav-link d-flex align-items-center" href="./user_management_page.html">
        <i class="fa-solid fa-users-gear me-2">
        </i>
        User Management
       </a>
      </li>
     </ul>
     <div class="section-title px-2">
      Models
     </div>
     <div class="accordion accordion-flush" id="modelAccordion">
      <div class="accordion-item border-0">
       <h2 class="accordion-header" id="headingModel">
        <button aria-controls="collapseModel" aria-expanded="false" class="accordion-button collapsed py-2" data-bs-target="#collapseModel" data-bs-toggle="collapse" type="button">
         <i class="fa-solid fa-brain me-2">
         </i>
         Model Management
        </button>
       </h2>
       <div aria-labelledby="headingModel" class="accordion-collapse collapse" data-bs-parent="#modelAccordion" id="collapseModel">
        <div class="accordion-body py-2">
         <ul class="nav nav-pills flex-column gap-1">
          <li>
           <a class="nav-link ps-4" href="./model_management_page.html">
            <i class="fa-solid fa-brain me-2">
            </i>
            Models Overview
           </a>
          </li>
          <li>
           <a class="nav-link ps-4" href="{{ url_for('model_management') }}">
            <i class="fa-solid fa-rocket me-2">
            </i>
            Train New Model
           </a>
          </li>
         </ul>
        </div>
       </div>
      </div>
     </div>
     <div class="section-title px-2">
      Insights
     </div>
     <ul class="nav nav-pills flex-column mb-2">
      <li class="nav-item">
       <a class="nav-link d-flex align-items-center" href="./forecast_dashboard.html">
        <i class="fa-solid fa-chart-line me-2">
        </i>
        Forecasts
       </a>
      </li>
     </ul>
    </nav>
    <div class="mt-auto p-3 border-top small text-muted">
     <div>
      ©
      <span id="year-admin">
       2025
      </span>
      ACME Foods
     </div>
    </div>
   </div>
  </div>
  <!-- MAIN CONTENT -->
  <main class="admin-main">
   <div class="container-fluid py-3">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="breadcrumb">
     <ol class="breadcrumb mb-2">
      <li class="breadcrumb-item">
       <a href="{{ url_for('admin_dashboard') }}">
        Admin
       </a>
      </li>
      <li class="breadcrumb-item">
       <a href="{{ url_for('upload_page') }}">
        Data Management
       </a>
      </li>
      <li aria-current="page" class="breadcrumb-item active">
       Product Management
      </li>
     </ol>
    </nav>
    <!-- Page Header -->
    <div class="page-header">
     <div class="d-flex align-items-center gap-3">
      <h1 class="page-title m-0">
       Product Management
      </h1>
      <span class="badge-soft info">
       <i class="fa-solid fa-info-circle">
       </i>
       Manage catalog used by forecasting models
      </span>
     </div>
     <div class="d-flex align-items-center gap-2">
      <button class="btn btn-primary" id="btnAddProduct">
       <i class="fa-solid fa-plus me-2">
       </i>
       Add New Product
      </button>
      </div>
     </div>
    </div>
    <!-- System Feedback (hidden until needed) -->
    <div class="alert alert-warning d-none" id="systemFeedback" role="alert">
     <i class="fa-solid fa-triangle-exclamation me-2">
     </i>
     <span id="feedbackText">
      System message placeholder…
     </span>
    </div>
    <!-- Filters & Tools -->
    <div class="card mb-3">
     <div class="card-body">
      <div class="row g-2 align-items-center">
       <div class="col-12 col-md-4">
        <label class="form-label mb-1" for="searchInput">
         Search
        </label>
        <input class="form-control" id="searchInput" placeholder="Search by ID or Product Name" type="text">
        </input>
       </div>
       <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="categoryFilter">
         Category
        </label>
        <select class="form-select" id="categoryFilter">
         <option value="">
          All Categories
         </option>
         <option>
          Beverages
         </option>
         <option>
          Snacks
         </option>
         <option>
          Bakery
         </option>
         <option>
          Dairy
         </option>
         <option>
          Produce
         </option>
        </select>
       </div>
       <div class="col-6 col-md-3">
        <label class="form-label mb-1" for="sortSelect">
         Sort by
        </label>
        <select class="form-select" id="sortSelect">
         <option value="dateAdded|desc">
          Date Added (Newest)
         </option>
         <option value="dateAdded|asc">
          Date Added (Oldest)
         </option>
         <option value="product_name|asc">
          Name (A–Z)
         </option>
         <option value="product_name|desc">
          Name (Z–A)
         </option>
         <option value="price|asc">
          Price (Low–High)
         </option>
         <option value="price|desc">
          Price (High–Low)
         </option>
        </select>
       </div>
       <div class="col-12 col-md-2 d-flex align-items-end">
        <button class="btn btn-light w-100" id="btnResetFilters">
         <i class="fa-solid fa-rotate-left me-2">
         </i>
         Reset
        </button>
       </div>
      </div>
     </div>
    </div>
    <div class="row g-3">
     <div class="col-12 col-xl-9">
      <!-- Products Table Card -->
      <div class="card">
       <div class="card-header">
        <div class="title">
         Products
        </div>
        <div class="text-muted small">
         CRUD operations with sorting &amp; pagination
        </div>
       </div>
       <div class="card-body p-0">
        <div class="table-responsive">
         <table class="table table-theme align-middle mb-0" id="productsTable">
          <thead>
           <tr>
            <th class="sortable" data-col="product_id">
             Product ID
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable" data-col="product_name">
             Product Name
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable" data-col="category">
             Category
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable text-end" data-col="price">
             Unit Price
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable text-end" data-col="stock">
             In Stock
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable" data-col="dateAdded">
             Date Added
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="text-center">
             Actions
            </th>
           </tr>
          </thead>
          <tbody id="tableBody">
           <!-- Loading skeleton rows (populated by JS initially) -->
          </tbody>
         </table>
        </div>
       </div>
       <div class="card-footer d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="text-muted small" id="paginationInfo">
         Loading…
        </div>
        <nav aria-label="Products pagination">
         <ul class="pagination pagination-sm mb-0" id="pagination">
          <!-- Pagination items -->
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="col-12 col-xl-3">
      <!-- Insights / Visualization -->
      <div class="card h-100">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-chart-pie text-secondary">
         </i>
         Products by Category
        </div>
        <div class="text-muted small">
         Interactive &amp; responsive
        </div>
       </div>
       <div class="card-body">
        <canvas aria-label="Products by category chart" height="220" id="categoryChart" role="img">
        </canvas>
        <div class="mt-3 d-flex align-items-center gap-2 small text-muted">
         <i class="fa-regular fa-circle-question">
         </i>
         <span>
          Chart updates as you add, edit, or delete products.
         </span>
        </div>
       </div>
      </div>
     </div>
    </div>
    <!-- Bottom Info Bar (optional logs) -->
    <div class="bottom-bar mt-3">
     <div class="log-line">
      [INFO] Ready • Use Add New Product to create an item • Click column headers to sort • Use pagination to navigate
     </div>
    </div>
   </div>
   <!-- ADMIN COMPONENT: Footer (Role: Admin) -->
   <style>
    .admin-footer { background:#fff; border-top:1px solid #e9ecef; }
      .admin-footer a { color: var(--secondary); }
      .admin-footer a:hover { color: #6f1e49; text-decoration: underline; }
   </style>
   <footer class="admin-footer py-3 mt-auto">
    <div class="container-fluid d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
     <div class="d-flex align-items-center gap-2">
      <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/acme/20/20';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68a81bcf3010074de4818175/logos/logo_32990785-4b39-4b20-94b8-b390fa991550.jpg" style="height:20px;width:20px;border-radius:.25rem;"/>
      <span class="text-muted small">
       © 2025 ACME Foods
      </span>
     </div>
     <div class="d-flex align-items-center gap-3 small">
      <a class="text-decoration-none" href="{{ url_for('upload_page') }}">
       <i class="fa-solid fa-file-arrow-up me-1">
       </i>
       Upload
      </a>
      <a class="text-decoration-none" href="{{ url_for('model_management') }}">
       <i class="fa-solid fa-rocket me-1">
       </i>
       Train
      </a>
     </div>
    </div>
   </footer>
  </main>
  <!-- Scripts: Bootstrap Bundle, SweetAlert2, Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
  </script>
  <script>
    // === STATE ===
    let products = [];
    let isLoading = true;
    let errorMessage = '';
    let currentPage = 1;
    const pageSize = 10;
    let sortColumn = 'dateAdded';
    let sortDirection = 'desc';

    const $tableBody = document.getElementById('tableBody');
    const $pagination = document.getElementById('pagination');
    const $paginationInfo = document.getElementById('paginationInfo');
    const $searchInput = document.getElementById('searchInput');
    const $globalSearch = document.getElementById('globalSearch');
    const $categoryFilter = document.getElementById('categoryFilter');
    const $sortSelect = document.getElementById('sortSelect');
    const $systemFeedback = document.getElementById('systemFeedback');
    const $feedbackText = document.getElementById('feedbackText');

    const currency = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const dateFmt = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: '2-digit' });

    // === FETCH FROM SERVER ===
    async function fetchProducts() {
        try {
            isLoading = true;
            renderTable(); // show skeleton
            const res = await fetch('/api/admin/products');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            products = await res.json();
            // Normalize field names (API returns `name`, not `product_name`)
            products = products.map(p => ({
                ...p,
                product_name: p.name,
                dateAdded: p.date_added
            }));
            errorMessage = '';
        } catch (err) {
            errorMessage = `Failed to load products: ${err.message}`;
            console.error(err);
        } finally {
            isLoading = false;
            renderTable();
            updateChart();
        }
    }

    // === ADD PRODUCT ===
    async function onAddNewProduct() {
        const { value: form } = await Swal.fire({
            title: 'Add New Product',
            html: getProductFormHtml(),
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Save Product',
            preConfirm: () => collectProductFormValues()
        });

        if (!form) return;

        try {
            const res = await fetch('/api/admin/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: generateNewId(),
                    name: form.product_name,
                    category: form.category,
                    price: parseFloat(form.price),
                    stock: parseInt(form.stock, 10)
                })
            });

            if (!res.ok) throw new Error(await res.text());
            const newProduct = await res.json();
            products.push({
                ...newProduct,
                product_name: newProduct.name,
                dateAdded: newProduct.date_added
            });
            toast('Product added', 'success');
            renderTable();
            updateChart();
        } catch (err) {
            toast(`Add failed: ${err.message}`, 'error');
        }
    }

    // === EDIT PRODUCT ===
    async function onEditProduct(id) {
        const p = products.find(x => x.id === id);
        if (!p) return;

        const { value: form } = await Swal.fire({
            title: `Edit ${p.product_name}`,
            html: getProductFormHtml(p),
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Save Changes',
            preConfirm: () => collectProductFormValues()
        });

        if (!form) return;

        try {
            const res = await fetch(`/api/admin/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: form.product_name,
                    category: form.category,
                    price: parseFloat(form.price),
                    stock: parseInt(form.stock, 10)
                })
            });

            if (!res.ok) throw new Error(await res.text());
            const updated = await res.json();
            Object.assign(p, {
                product_name: updated.name,
                category: updated.category,
                price: updated.price,
                stock: updated.stock
            });
            toast('Product updated', 'success');
            renderTable();
            updateChart();
        } catch (err) {
            toast(`Update failed: ${err.message}`, 'error');
        }
    }

    // === DELETE PRODUCT ===
    async function onDeleteProduct(id) {
        const p = products.find(x => x.id === id);
        if (!p) return;

        const { isConfirmed } = await Swal.fire({
            title: 'Delete Product',
            html: `<div class="text-start">Delete <strong>${escapeHtml(p.product_name)}</strong>?</div>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            confirmButtonColor: '#CD2026'
        });

        if (!isConfirmed) return;

        try {
            const res = await fetch(`/api/admin/products/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text());
            products = products.filter(x => x.id !== id);
            toast('Product deleted', 'success');
            renderTable();
            updateChart();
        } catch (err) {
            toast(`Delete failed: ${err.message}`, 'error');
        }
    }

    // === FORM HELPERS ===
    function getProductFormHtml(prefill) {
        const c = prefill?.category || '';
        const price = prefill?.price ?? '';
        const stock = prefill?.stock ?? '';
        return `
            <form id="productForm" class="text-start">
              <div class="mb-3">
                <label class="form-label">Product Name <span class="text-danger">*</span></label>
                <input id="pf_name" class="form-control" type="text" placeholder="e.g., Orange Juice 1L" value="${prefill ? escapeHtml(prefill.product_name) : ''}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Category <span class="text-danger">*</span></label>
                <select id="pf_category" class="form-select" required>
                  <option value="">Select a category</option>
                  <option ${c==='Beverages'?'selected':''}>Beverages</option>
                  <option ${c==='Snacks'?'selected':''}>Snacks</option>
                  <option ${c==='Bakery'?'selected':''}>Bakery</option>
                  <option ${c==='Dairy'?'selected':''}>Dairy</option>
                  <option ${c==='Produce'?'selected':''}>Produce</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Unit Price (USD) <span class="text-danger">*</span></label>
                <input id="pf_price" class="form-control" type="number" step="0.01" min="0" placeholder="e.g., 3.49" value="${price}">
              </div>
              <div class="mb-1">
                <label class="form-label">In Stock <span class="text-danger">*</span></label>
                <input id="pf_stock" class="form-control" type="number" step="1" min="0" placeholder="e.g., 100" value="${stock}">
              </div>
              <small class="text-muted">Fields marked * are required.</small>
            </form>`;
    }

    function collectProductFormValues() {
        const name = document.getElementById('pf_name').value.trim();
        const category = document.getElementById('pf_category').value;
        const price = document.getElementById('pf_price').value;
        const stock = document.getElementById('pf_stock').value;
        const errors = [];
        if (!name) errors.push('Product Name is required');
        if (!category) errors.push('Category is required');
        if (price === '' || isNaN(price) || Number(price) < 0) errors.push('Valid Price is required');
        if (stock === '' || isNaN(stock) || Number(stock) < 0) errors.push('Valid Stock is required');
        if (errors.length) {
            Swal.showValidationMessage(errors.join('<br>'));
            return false;
        }
        return { product_name: name, category, price, stock };
    }

    function generateNewId() {
        const nums = products.map(p => parseInt(p.product_id.replace(/\D/g, ''), 10)).filter(n => !isNaN(n));
        const next = (nums.length ? Math.max(...nums) : 1000) + 1;
        return `P-${next}`;
    }

    // === TOAST & FEEDBACK ===
    function toast(text, icon = 'info') {
        const T = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false,
            timer: 2000, timerProgressBar: true
        });
        T.fire({ icon, title: text });
    }

    function showSystemFeedback(msg) {
        $feedbackText.textContent = msg;
        $systemFeedback.classList.remove('d-none');
    }

    function hideSystemFeedback() {
        $systemFeedback.classList.add('d-none');
    }

    function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[s]));
    }

    // === RENDERING ===
    function applyFilters(data) {
        const q = ($searchInput.value || '').trim().toLowerCase();
        const category = $categoryFilter.value;
        return data.filter(p => {
            const matchQ = !q || p.product_id.toLowerCase().includes(q) || p.product_name.toLowerCase().includes(q);
            const matchCat = !category || p.category === category;
            return matchQ && matchCat;
        });
    }

    function compare(a, b, col) {
        const va = a[col], vb = b[col];
        if (col === 'price' || col === 'stock') return va - vb;
        if (col === 'dateAdded') return new Date(a.dateAdded) - new Date(b.dateAdded);
        return String(va).localeCompare(String(vb), 'en', { sensitivity: 'base' });
    }

    function applySort(data) {
        return data.slice().sort((a, b) => {
            const res = compare(a, b, sortColumn);
            return sortDirection === 'asc' ? res : -res;
        });
    }

    function paginate(data) {
        const total = data.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        return {
            pageItems: data.slice(start, end),
            total, totalPages,
            start: start + 1,
            end: Math.min(end, total)
        };
    }

    function renderTable() {
        if (isLoading) {
            $tableBody.innerHTML = Array(6).fill().map(() => `
                <tr><td colspan="7"><div class="skeleton" style="height:18px;"></div></td></tr>
            `).join('');
            $paginationInfo.textContent = 'Loading…';
            $pagination.innerHTML = '';
            return;
        }

        if (errorMessage) {
            showSystemFeedback(errorMessage);
        } else {
            hideSystemFeedback();
        }

        const filtered = applyFilters(products);
        const sorted = applySort(filtered);
        const { pageItems, total, totalPages, start, end } = paginate(sorted);

        $tableBody.innerHTML = pageItems.map(p => `
            <tr>
              <td><span class="text-muted">${p.product_id}</span></td>
              <td><span class="fw-semibold">${escapeHtml(p.product_name)}</span></td>
              <td><span class="badge-soft primary">${p.category}</span></td>
              <td class="text-end">${currency.format(p.price)}</td>
              <td class="text-end">${p.stock.toLocaleString()}</td>
              <td>${dateFmt.format(new Date(p.dateAdded))}</td>
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-light" title="Edit" onclick="onEditProduct(${p.id})"><i class="fa-solid fa-pen"></i></button>
                  <button class="btn btn-danger" title="Delete" onclick="onDeleteProduct(${p.id})"><i class="fa-solid fa-trash"></i></button>
                </div>
              </td>
            </tr>`).join('');

        $paginationInfo.textContent = total ? `Showing ${start}-${end} of ${total}` : 'No products';

        // Pagination
        $pagination.innerHTML = '';
        const prevDisabled = currentPage === 1 ? ' disabled' : '';
        const nextDisabled = currentPage === totalPages ? ' disabled' : '';
        $pagination.insertAdjacentHTML('beforeend', `
            <li class="page-item${prevDisabled}"><a class="page-link" href="#" onclick="changePage(${currentPage - 1});return false;">Previous</a></li>`);
        const window = 5;
        let startPage = Math.max(1, currentPage - Math.floor(window / 2));
        let endPage = Math.min(totalPages, startPage + window - 1);
        if (endPage - startPage < window - 1) startPage = Math.max(1, endPage - window + 1);
        for (let i = startPage; i <= endPage; i++) {
            $pagination.insertAdjacentHTML('beforeend', `
                <li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="changePage(${i});return false;">${i}</a></li>`);
        }
        $pagination.insertAdjacentHTML('beforeend', `
            <li class="page-item${nextDisabled}"><a class="page-link" href="#" onclick="changePage(${currentPage + 1});return false;">Next</a></li>`);

        updateSortIndicators();
    }

    function updateSortIndicators() {
        document.querySelectorAll('#productsTable thead th.sortable').forEach(th => {
            const icon = th.querySelector('i');
            if (!icon) return;
            icon.className = 'fa-solid fa-sort ms-1 text-muted';
            if (th.dataset.col === sortColumn) {
                icon.className = sortDirection === 'asc'
                    ? 'fa-solid fa-arrow-up-wide-short ms-1 text-primary'
                    : 'fa-solid fa-arrow-down-wide-short ms-1 text-primary';
            }
        });
    }

    function changePage(p) {
        currentPage = Math.max(1, p);
        renderTable();
    }

    // === CHART ===
    let categoryChart;
    function updateChart() {
        const counts = products.reduce((acc, p) => {
            acc[p.category] = (acc[p.category] || 0) + 1;
            return acc;
        }, {});
        const labels = Object.keys(counts).sort();
        const data = labels.map(l => counts[l]);
        const ctx = document.getElementById('categoryChart');
        const palette = ['#f08e1b', '#9a296a', '#0099D2', '#00774E', '#CD2026', '#6C757D'];
        if (!categoryChart) {
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: palette.slice(0, labels.length), borderWidth: 1 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } else {
            categoryChart.data.labels = labels;
            categoryChart.data.datasets[0].data = data;
            categoryChart.data.datasets[0].backgroundColor = palette.slice(0, labels.length);
            categoryChart.update();
        }
    }

    // === EVENT LISTENERS ===
    document.getElementById('btnAddProduct').addEventListener('click', onAddNewProduct);
    document.getElementById('btnResetFilters').addEventListener('click', () => {
        $searchInput.value = $categoryFilter.value = '';
        $sortSelect.value = 'dateAdded|desc';
        sortColumn = 'dateAdded'; sortDirection = 'desc';
        currentPage = 1;
        renderTable();
    });

    $searchInput.addEventListener('input', () => { currentPage = 1; renderTable(); });
    $globalSearch.addEventListener('input', () => {
        $searchInput.value = $globalSearch.value;
        currentPage = 1; renderTable();
    });
    $categoryFilter.addEventListener('change', () => { currentPage = 1; renderTable(); });
    $sortSelect.addEventListener('change', e => {
        const [col, dir] = e.target.value.split('|');
        sortColumn = col; sortDirection = dir;
        currentPage = 1; renderTable();
    });

    document.querySelectorAll('#productsTable thead th.sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            sortDirection = sortColumn === col && sortDirection === 'asc' ? 'desc' : 'asc';
            sortColumn = col;
            renderTable();
        });
    });

    // Expose for inline onclick
    window.onEditProduct = onEditProduct;
    window.onDeleteProduct = onDeleteProduct;
    window.changePage = changePage;

    // === INIT ===
    setYear();
    fetchProducts(); // <-- This loads from MySQL
</script>
 </body>
</html>
