<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Login | Sales Forecasting System</title>
  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <!-- Global Theme CSS (update path for Flask or static as needed) -->
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet"/>
  <!-- Page-specific CSS -->
  <link href="{{ url_for('static', filename='css/login_page.css') }}" rel="stylesheet"/>
</head>
<body class="d-flex flex-column min-vh-100">
  <!-- HEADER -->
  <style>
    .public-navbar { background-color: var(--color-primary, #fff); border-bottom:1px solid #e9ecef; }
    .public-navbar .navbar-brand { color: var(--secondary, #0099D2); }
    .public-navbar .nav-link { color: var(--color-text-light, #555);}
    .public-navbar .nav-link:hover { color: var(--color-light, #fff);}
  </style>
  <header class="public-navbar sticky-top">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg" aria-label="Main navigation">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('login') }}">
          <img src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68a81bcf3010074de4818175/logos/logo_32990785-4b39-4b20-94b8-b390fa991550.jpg" 
               alt="Sales Forecasting Logo" class="me-2 rounded logo-holder" style="height:28px;width:28px;border-radius:.25rem;" 
               onerror="this.onerror=null;this.src='https://placehold.co/64x64/0099D2/FFFFFF?text=SF'"/>
          Sales Forecasting
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#publicNavbar" aria-controls="publicNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="publicNavbar">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="#">About</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Help</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Privacy</a></li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <!-- MAIN SECTION -->
  <main class="flex-grow-1 d-flex flex-column justify-content-center auth-hero">
    <section class="container-xl py-5 px-3">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-6 col-xl-5">
          <div class="text-center mb-4">
            <img alt="ACME Foods" class="rounded logo-holder shadow-sm" 
                onerror="this.onerror=null;this.src='https://placehold.co/64x64/0099D2/FFFFFF?text=SF'" 
                src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68a81bcf3010074de4818175/logos/logo_32990785-4b39-4b20-94b8-b390fa991550.jpg" 
                style="height:64px;width:64px"/>
            <h1 class="h4 fw-bold mt-3 mb-1">Sign in to Sales Forecasting</h1>
            <p class="text-muted small mb-0">Secure access for Admins and Users</p>
          </div>
          <div class="login-form-container card shadow-sm p-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
              </div>
              {% endfor %}
            {% endif %}
            {% endwith %}
            <form action="{{ url_for('login') }}" id="loginForm" method="POST" novalidate>
              <div class="mb-3">
                <label class="form-label" for="username">Username</label>
                <div class="input-group has-validation">
                  <span class="input-group-text"><i class="fas fa-user"></i></span>
                  <input autocomplete="username" class="form-control" id="username" name="username" placeholder="Enter your username" required type="text"/>
                  <div class="invalid-feedback" id="usernameFeedback">Please enter your username.</div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="password">Password</label>
                <div class="input-group has-validation">
                  <span class="input-group-text"><i class="fas fa-lock"></i></span>
                  <input aria-describedby="togglePasswordHelp" autocomplete="current-password" class="form-control" id="password" name="password" placeholder="Enter your password" required type="password"/>
                  <button aria-label="Toggle password visibility" class="btn btn-light" id="togglePassword" type="button">
                    <i class="fas fa-eye-slash" id="togglePasswordIcon"></i>
                  </button>
                  <div class="invalid-feedback" id="passwordFeedback">Please enter your password.</div>
                </div>
                <small id="capsLockIndicator" class="form-text text-warning d-none mt-2">
                  <i class="fas fa-exclamation-triangle me-1"></i>Caps Lock is On.
                </small>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                  <input class="form-check-input" id="rememberMe" name="rememberMe" type="checkbox" value="1"/>
                  <label class="form-check-label" for="rememberMe">Remember me</label>
                </div>
                <a href="#" class="small text-decoration-none">Forgot password?</a>
              </div>
              <button class="btn btn-primary w-100 fw-bold" id="loginBtn" type="submit">
                <span id="btnText">Login</span>
                <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
              </button>
            </form>
            <div class="card bg-light mt-4 p-3 border-secondary-subtle">
              <h6 class="card-title fw-bold mb-2 text-dark">Test Accounts</h6>
              <ul class="list-unstyled mb-0 d-grid gap-2">
                <li><span class="badge bg-primary-soft text-primary-emphasis fw-semibold me-2">Admin</span> <code>admin</code> / <code>password</code></li>
                <li><span class="badge bg-info-soft text-info-emphasis fw-semibold me-2">User</span> <code>user</code> / <code>password</code></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- FOOTER -->
  <footer class="bg-dark text-white-50 py-4 mt-auto">
    <div class="container-xl">
      <div class="row align-items-center">
        <div class="col-md-6 text-center text-md-start">
          <small>&copy; 2024 Sales Forecasting. All rights reserved.</small>
        </div>
        <div class="col-md-6 text-center text-md-end mt-2 mt-md-0">
          <small>Powered by <a href="#" class="text-white text-decoration-none">Google AI</a></small>
        </div>
      </div>
    </div>
  </footer>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 for alerts (optional for enhanced UX) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>
  <!-- Page Logic/JS (for local/demo use, comment/remove if server-side login only) -->
  <script>
    (() => {
      // User data hardcoded for demo; remove for server-side validation in production.
      const users = [
        { username: 'admin', password: 'password', role: 'admin', redirect: 'admin_dashboard.html' },
        { username: 'user',  password: 'password', role: 'user',  redirect: 'user_dashboard.html' },
        { username: 'guest', password: 'password', role: 'guest', redirect: 'user_dashboard.html' }
      ];

      const form = document.getElementById('loginForm');
      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');
      const rememberEl = document.getElementById('rememberMe');
      const loginBtn = document.getElementById('loginBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      const capsLockIndicator = document.getElementById('capsLockIndicator');
      const togglePasswordEl = document.getElementById('togglePassword');
      const toggleIconEl = document.getElementById('togglePasswordIcon') || document.getElementById('toggleIcon');

      // Restore username if "remember me"
      const savedUsername = localStorage.getItem('sf_username');
      if (savedUsername) {
        usernameEl.value = savedUsername;
        rememberEl.checked = true;
      }
      // Toggle password
      togglePasswordEl.addEventListener('click', () => {
        const type = passwordEl.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordEl.setAttribute('type', type);
        toggleIconEl.classList.toggle('fa-eye-slash');
        toggleIconEl.classList.toggle('fa-eye');
      });
      // Caps Lock indicator
      passwordEl.addEventListener('keyup', (e) => {
        const isCaps = e.getModifierState && e.getModifierState('CapsLock');
        if (isCaps) {
          capsLockIndicator.classList.remove('d-none');
        } else {
          capsLockIndicator.classList.add('d-none');
        }
      });
      const setLoading = (loading) => {
        loginBtn.disabled = loading;
        if (loading) {
          btnText.classList.add('d-none');
          btnSpinner.classList.remove('d-none');
        } else {
          btnText.classList.remove('d-none');
          btnSpinner.classList.add('d-none');
        }
      };
      // For demo: prevent double alerts
      const showError = (message) => {
        if (!document.querySelector('.alert-danger')) {
          const errorHtml = `<div class="alert alert-danger mb-3" role="alert">${message}</div>`;
          form.insertAdjacentHTML('beforebegin', errorHtml);
        }
      };
      const clearError = () => {
        const existingAlert = form.previousElementSibling;
        if (existingAlert && existingAlert.classList.contains('alert-danger')) {
          existingAlert.remove();
        }
      };
      const validate = () => {
        let valid = true;
        if (!usernameEl.value.trim()) {
          usernameEl.classList.add('is-invalid');
          document.getElementById('usernameFeedback').textContent = 'Username is required.';
          valid = false;
        } else {
          usernameEl.classList.remove('is-invalid');
        }
        if (!passwordEl.value) {
          passwordEl.classList.add('is-invalid');
          document.getElementById('passwordFeedback').textContent = 'Password is required.';
          valid = false;
        } else {
          passwordEl.classList.remove('is-invalid');
        }
        return valid;
      };
      form && form.addEventListener('submit', function(e) {
        {% if not config['DEMO_MODE'] %}
        // For backend: let Flask handle POST.
        {% else %}
        e.preventDefault();
        clearError();
        if (!validate()) return;
        setLoading(true);
        setTimeout(() => {
          const u = usernameEl.value.trim();
          const p = passwordEl.value;
          const found = users.find(x => x.username === u && x.password === p);
          if (found) {
            if (rememberEl.checked) {
              localStorage.setItem('sf_username', u);
            } else {
              localStorage.removeItem('sf_username');
            }
            Swal.fire({
              icon: 'success',
              title: 'Welcome back!',
              text: `Signed in as ${found.role}. Redirecting...`,
              showConfirmButton: false,
              timer: 1400,
              timerProgressBar: true,
              didOpen: () => { Swal.showLoading(); }
            }).then(() => {
              window.location.href = found.redirect;
            });
          } else {
            setLoading(false);
            showError('Invalid username or password.');
            Swal.fire({
              icon: 'error',
              title: 'Authentication failed',
              text: 'Invalid username or password.'
            });
          }
        }, 800);
        {% endif %}
      });
    })();
  </script>
</body>
</html>
